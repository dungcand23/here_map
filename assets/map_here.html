<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>HERE Map</title>
    <meta name="viewport" content="initial-scale=1.0,width=device-width" />
    <style>
        html, body {
          margin: 0;
          padding: 0;
          overflow: hidden;
          height: 100%;
          width: 100%;
        }
        #mapContainer {
          width: 100%;
          height: 100%;
        }
    </style>

    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <link rel="stylesheet" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
</head>

<body>
<div id="mapContainer"></div>

<script>
    let platform = null;
    let layers = null;
    let map = null;
    let behavior = null;
    let ui = null;

    let _pendingPayload = null;

    function showBanner(msg) {
      try {
        let b = document.getElementById('hereBanner');
        if (!b) {
          b = document.createElement('div');
          b.id = 'hereBanner';
          b.style.position = 'absolute';
          b.style.top = '12px';
          b.style.left = '12px';
          b.style.right = '12px';
          b.style.zIndex = '9999';
          b.style.padding = '10px 12px';
          b.style.borderRadius = '12px';
          b.style.background = 'rgba(255,255,255,0.95)';
          b.style.boxShadow = '0 10px 24px rgba(0,0,0,0.18)';
          b.style.fontFamily = 'Arial, sans-serif';
          b.style.fontSize = '13px';
          document.body.appendChild(b);
        }
        b.textContent = msg;
      } catch (_) {}
    }

    function getApiKey() {
      const v = window.HERE_API_KEY || window.hereApiKey || '';
      return (typeof v === 'string') ? v.trim() : '';
    }

    function initMap(apiKey) {
      platform = new H.service.Platform({ apikey: apiKey });
      layers = platform.createDefaultLayers();
      map = new H.Map(
        document.getElementById("mapContainer"),
        layers.vector.normal.map,
        {
          zoom: 10,
          center: { lat: 10.762622, lng: 106.660172 }
        }
      );
      behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
      ui = H.ui.UI.createDefault(map, layers);
      window.addEventListener('resize', () => map.getViewPort().resize());

      // nếu đã có payload chờ -> render luôn
      if (_pendingPayload) {
        const tmp = _pendingPayload;
        _pendingPayload = null;
        window.updateMap(tmp);
      }
    }

    // Flutter có thể gọi trước: window.setHereApiKey('...')
    window.setHereApiKey = function(key) {
      window.HERE_API_KEY = (key || '').toString();
      if (!map) {
        const k = getApiKey();
        if (k && k.length > 10) {
          initMap(k);
        } else {
          showBanner('Thiếu HERE API key.');
        }
      }
    };

    // ✅ Group tách riêng marker / polyline (tránh clear nhầm & tránh "dữ liệu ma")
    let markersGroup = null;
    let polylinesGroup = null;

    function ensureGroups() {
      if (!map) return;
      if (!markersGroup) {
        markersGroup = new H.map.Group();
        map.addObject(markersGroup);
      }
      if (!polylinesGroup) {
        polylinesGroup = new H.map.Group();
        map.addObject(polylinesGroup);
      }
    }

    function clearMarkers() { markersGroup.removeAll(); }
    function clearPolylines() { polylinesGroup.removeAll(); }

    function markerSvgNumber(label, color) {
      const fill = color || '#1A73E8';
      const text = String(label || '');
      return `
      <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34">
        <circle cx="17" cy="17" r="14" fill="${fill}" />
        <circle cx="17" cy="17" r="14" fill="none" stroke="white" stroke-width="3"/>
        <text x="17" y="22" text-anchor="middle" font-family="Arial"
              font-size="14" font-weight="700" fill="white">${text}</text>
      </svg>`;
    }

    function drawPolyline(polylinePayload) {
      if (!polylinePayload) return;

      // Flexible polyline string
      if (typeof polylinePayload === 'string') {
        try {
          const ls = H.geo.LineString.fromFlexiblePolyline(polylinePayload);
          const pl = new H.map.Polyline(ls, { style: { lineWidth: 6, strokeColor: '#1A73E8' } });
          polylinesGroup.addObject(pl);
          map.getViewModel().setLookAtData({ bounds: pl.getBoundingBox() }, true);
          return;
        } catch (e) {
          console.error('[HERE][mobile] flexible polyline decode failed', e);
        }
      }

      // Points array [{lat,lng},...]
      if (Array.isArray(polylinePayload)) {
        try {
          const ls = new H.geo.LineString();
          polylinePayload.forEach(p => {
            const lat = Number(p.lat);
            const lng = Number(p.lng);
            if (isFinite(lat) && isFinite(lng)) ls.pushPoint({ lat, lng });
          });
          if (ls.getPointCount() < 2) return;
          const pl = new H.map.Polyline(ls, { style: { lineWidth: 6, strokeColor: '#1A73E8' } });
          polylinesGroup.addObject(pl);
          map.getViewModel().setLookAtData({ bounds: pl.getBoundingBox() }, true);
          return;
        } catch (e) {
          console.error('[HERE][mobile] points polyline draw failed', e);
        }
      }

      console.warn('[HERE][mobile] Unsupported polyline format:', polylinePayload);
    }

    // Flutter → updateMap(payloadJsonString)
    window.updateMap = function(payloadStr) {
      if (!payloadStr) return;

      // chưa có map (do chưa inject key) -> giữ payload
      if (!map) {
        _pendingPayload = payloadStr;
        const k = getApiKey();
        if (k && k.length > 10) {
          initMap(k);
        } else {
          showBanner('Thiếu HERE API key.');
        }
        return;
      }

      ensureGroups();

      let data = {};
      try { data = JSON.parse(payloadStr); } catch (e) { return; }

      if (data.clearMarkers) clearMarkers();
      if (data.clearPolylines) clearPolylines();

      // Markers
      if (Array.isArray(data.markers)) {
        data.markers.forEach(m => {
          const lat = Number(m.lat);
          const lng = Number(m.lng);
          if (!isFinite(lat) || !isFinite(lng)) return;
          const icon = new H.map.Icon(markerSvgNumber(m.label, m.color || '#1A73E8'));
          const marker = new H.map.Marker({ lat, lng }, { icon });
          markersGroup.addObject(marker);
        });
      }

      // Polyline
      if (data.polyline) drawPolyline(data.polyline);

      // Center/Zoom
      if (data.center && data.center.lat != null && data.center.lng != null) {
        map.setCenter({ lat: Number(data.center.lat), lng: Number(data.center.lng) }, true);
      }
      if (data.zoom != null) map.setZoom(Number(data.zoom), true);
    };

    // Boot: nếu page load đã có key sẵn
    (function boot() {
      const k = getApiKey();
      if (k && k.length > 10) {
        initMap(k);
      } else {
        // Không init ngay — chờ Flutter inject key
        showBanner('Đang chờ HERE API key...');
      }
    })();
</script>
</body>
</html>
